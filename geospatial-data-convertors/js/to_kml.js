!function(e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).tokml=e()}(function(){return function n(o,i,a){function u(t,e){if(!i[t]){if(!o[t]){var r="function"==typeof require&&require;if(!e&&r)return r(t,!0);if(l)return l(t,!0);throw(r=new Error("Cannot find module '"+t+"'")).code="MODULE_NOT_FOUND",r}r=i[t]={exports:{}},o[t][0].call(r.exports,function(e){return u(o[t][1][e]||e)},r,r.exports,n,o,i,a)}return i[t].exports}for(var l="function"==typeof require&&require,e=0;e<a.length;e++)u(a[e]);return u}({1:[function(e,t,r){var c=e("./lib/xml-escape"),p=e("./lib/strxml").tag;function n(l,s){return function(e){if(!e.properties||!f.valid(e.geometry))return"";var t=f.any(e.geometry);if(!t)return"";var r,n,o,i="",a="";!l.simplestyle||(r=function(e){var t="";e["marker-symbol"]&&(t=t+"ms"+e["marker-symbol"]);e["marker-color"]&&(t=t+"mc"+e["marker-color"].replace("#",""));e["marker-size"]&&(t=t+"ms"+e["marker-size"]);e.stroke&&(t=t+"s"+e.stroke.replace("#",""));e["stroke-width"]&&(t=t+"sw"+e["stroke-width"].toString().replace(".",""));e["stroke-opacity"]&&(t=t+"mo"+e["stroke-opacity"].toString().replace(".",""));e.fill&&(t=t+"f"+e.fill.replace("#",""));e["fill-opacity"]&&(t=t+"fo"+e["fill-opacity"].toString().replace(".",""));return t}(e.properties))&&(f.isPoint(e.geometry)&&!!((o=e.properties)["marker-size"]||o["marker-symbol"]||o["marker-color"])?(-1===s.indexOf(r)&&(n=e.properties,i=p("Style",{id:r},p("IconStyle",p("Icon",p("href",function(e){var t=e["marker-size"]||"medium",r=e["marker-symbol"]?"-"+e["marker-symbol"]:"",e=(e["marker-color"]||"7e7e7e").replace("#","");return"https://api.tiles.mapbox.com/v3/marker/pin-"+t.charAt(0)+r+"+"+e+".png"}(n))))+p("hotSpot",{xunits:"fraction",yunits:"fraction",x:"0.5",y:"0.5"},"")),s.push(r)),a=p("styleUrl","#"+r),delete(n=e.properties)["marker-size"],delete n["marker-symbol"],delete n["marker-color"],delete n["marker-shape"]):(f.isPolygon(e.geometry)||f.isLine(e.geometry))&&function(e){for(var t in e)if({stroke:!0,"stroke-opacity":!0,"stroke-width":!0,fill:!0,"fill-opacity":!0}[t])return!0}(e.properties)&&(-1===s.indexOf(r)&&(i=function(e,t){var r=p("LineStyle",p("color",d(e.stroke,e["stroke-opacity"])||"ff555555")+p("width",{},void 0===e["stroke-width"]?2:e["stroke-width"])),n="";(e.fill||e["fill-opacity"])&&(n=p("PolyStyle",p("color",{},d(e.fill,e["fill-opacity"])||"88555555")));return p("Style",{id:t},r+n)}(e.properties,r),s.push(r)),a=p("styleUrl","#"+r),delete(u=e.properties).stroke,delete u["stroke-opacity"],delete u["stroke-width"],delete u.fill,delete u["fill-opacity"]));var u={};return e.id&&(u.id=e.id),i+p("Placemark",u,((i=e.properties)[(u=l).name]?p("name",c(i[u.name])):"")+((i=e.properties)[(u=l).description]?p("description",c(i[u.description])):"")+(u=e.properties,p("ExtendedData",{},function(e){var t,r=[];for(t in e)e[t]?r.push([t,e[t]]):r.push([t,""]);return r}(u).map(m).join("")))+((u=e.properties)[(e=l).timestamp]?p("TimeStamp",p("when",c(u[e.timestamp]))):"")+t+a)}}t.exports=function(e,t){return'<?xml version="1.0" encoding="UTF-8"?>'+p("kml",{xmlns:"http://www.opengis.net/kml/2.2"},p("Document",(void 0!==(r=t=t||{documentName:void 0,documentDescription:void 0,name:"name",description:"description",simplestyle:!1,timestamp:"timestamp"}).documentName?p("name",r.documentName):"")+(void 0!==(r=t).documentDescription?p("description",r.documentDescription):"")+function(e,t){if(!e.type)return"";var r=[];switch(e.type){case"FeatureCollection":return e.features?e.features.map(n(t,r)).join(""):"";case"Feature":return n(t,r)(e);default:return n(t,r)({type:"Feature",geometry:e,properties:{}})}}(e,t)));var r};var f={Point:function(e){return p("Point",p("coordinates",e.coordinates.join(",")))},LineString:function(e){return p("LineString",p("coordinates",o(e.coordinates)))},Polygon:function(e){if(!e.coordinates.length)return"";var t=e.coordinates[0],e=e.coordinates.slice(1),t=p("outerBoundaryIs",p("LinearRing",p("coordinates",o(t)))),e=e.map(function(e){return p("innerBoundaryIs",p("LinearRing",p("coordinates",o(e))))}).join("");return p("Polygon",t+e)},MultiPoint:function(e){return e.coordinates.length?p("MultiGeometry",e.coordinates.map(function(e){return f.Point({coordinates:e})}).join("")):""},MultiPolygon:function(e){return e.coordinates.length?p("MultiGeometry",e.coordinates.map(function(e){return f.Polygon({coordinates:e})}).join("")):""},MultiLineString:function(e){return e.coordinates.length?p("MultiGeometry",e.coordinates.map(function(e){return f.LineString({coordinates:e})}).join("")):""},GeometryCollection:function(e){return p("MultiGeometry",e.geometries.map(f.any).join(""))},valid:function(e){return e&&e.type&&(e.coordinates||"GeometryCollection"===e.type&&e.geometries&&e.geometries.every(f.valid))},any:function(e){return f[e.type]?f[e.type](e):""},isPoint:function(e){return"Point"===e.type||"MultiPoint"===e.type},isPolygon:function(e){return"Polygon"===e.type||"MultiPolygon"===e.type},isLine:function(e){return"LineString"===e.type||"MultiLineString"===e.type}};function o(e){return e.map(function(e){return e.join(",")}).join(" ")}function m(e){return p("Data",{name:e[0]},p("value",{},c(e[1]?e[1].toString():"")))}function d(e,t){if("string"!=typeof e)return"";if(3===(e=e.replace("#","").toLowerCase()).length)e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2];else if(6!==e.length)return"";var r=e[0]+e[1],n=e[2]+e[3],o=e[4]+e[5],e="ff";return"number"==typeof t&&0<=t&&t<=1&&(-1<(e=(255*t).toString(16)).indexOf(".")&&(e=e.substr(0,e.indexOf("."))),e.length<2&&(e="0"+e)),e+o+n+r}},{"./lib/strxml":2,"./lib/xml-escape":3}],2:[function(e,t,r){var n=e("./xml-escape");function o(t){return Object.keys(t).length?" "+Object.keys(t).map(function(e){return e+'="'+n(t[e])+'"'}).join(" "):""}t.exports.attr=o,t.exports.tagClose=function(e,t){return"<"+e+o(t)+"/>"},t.exports.tag=function(e,t,r){!Array.isArray(t)&&"string"!=typeof t||(r=t,t={});Array.isArray(r)&&(r="\n"+r.map(function(e){return"  "+e}).join("\n")+"\n");return"<"+e+o(t)+">"+r+"</"+e+">"}},{"./xml-escape":3}],3:[function(e,t,r){(t.exports=function r(e,t){if(null!=e)return t=(t||"").replace(/[^&"<>\']/g,""),t="([&\"<>'])".replace(new RegExp("["+t+"]","g"),""),e.replace(new RegExp(t,"g"),function(e,t){return r.map[t]})}).map={">":"&gt;","<":"&lt;","'":"&apos;",'"':"&quot;","&":"&amp;"}},{}]},{},[1])(1)});